import _QRCodeStyling from 'qr-code-styling';
import { memo, useEffect, useMemo, useState } from 'react';

import styles from './QrCode.module.css';

const QRCodeStyling = _QRCodeStyling as unknown as typeof _QRCodeStyling.default;

type Props = {
  value: string;
  size: number;
  theme?: 'light' | 'dark';
};

const COLOR_LIGHT = '#000000';
const COLOR_DARK = '#ffffff';

const IMAGE_LIGHT =
  'PHN2ZyB3aWR0aD0iNDMiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0MyA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIuNDIxMzggMTAuMTkyM0MtMC43MzQyNTUgMTMuODcxNyAtMC44MTc0NjcgMTguOTkzNCAyLjI0MjE1IDIxLjYyMTVDNS4zMDE3NyAyNC4yNTYgMTAuMzM5MyAyMy40MDM1IDEzLjUwMTMgMTkuNzE3N0MxNi42NTY5IDE2LjAzODMgMTYuNzQwMSAxMC45MTY3IDEzLjY4MDUgOC4yODg1NEMxMi40ODM2IDcuMjU2NTIgMTAuOTczIDYuNzYyOTQgOS4zOTgzNCA2Ljc2Mjk0QzYuOTUzMiA2Ljc2Mjk0IDQuMzQxNjQgNy45NTUyMSAyLjQyMTM4IDEwLjE5MjNaIiBmaWxsPSJibGFjayIvPgo8cGF0aCBkPSJNMS41MDYxNCAyOS4yMzA0Qy0wLjg2ODU4NCAzMi4wNTA4IDAuMTYxOTU2IDM2LjgzOTIgMy44MTA0NiAzOS45MjI0QzcuNDU4OTYgNDMuMDA1NyAxMi4zNDkyIDQzLjIyMzYgMTQuNzI0IDQwLjQwMzJDMTcuMDk4NyAzNy41ODI3IDE2LjA2ODEgMzIuNzk0NCAxMi40MTk2IDI5LjcxMTJDMTAuNDg2NiAyOC4wNzY2IDguMjA3ODYgMjcuMjQ5NyA2LjE0MDM4IDI3LjI0OTdDNC4zMDMzMyAyNy4yNDk3IDIuNjI2MyAyNy45MDM1IDEuNTEyNTQgMjkuMjMwNCIgZmlsbD0iYmxhY2siLz4KPHBhdGggZD0iTTIyLjkyOTcgMzkuNTUwNkMxOC42NDc1IDQwLjkwMzIgMTUuNjk2NyA0My42NTk1IDE2LjMzNjggNDUuNzA0M0MxNi45ODMzIDQ3Ljc0OTEgMjAuOTc3NCA0OC4zMTMyIDI1LjI1OTYgNDYuOTU0M0MyOS41NDE4IDQ1LjYwMTcgMzIuNDkyNiA0Mi44NDU0IDMxLjg1MjUgNDAuODAwNkMzMS40NDI4IDM5LjUxMjIgMjkuNzAxOCAzOC44MDcxIDI3LjM5NzUgMzguODA3MUMyNi4wNDY5IDM4LjgwNzEgMjQuNTEwNyAzOS4wNDQyIDIyLjkyOTcgMzkuNTQ0MiIgZmlsbD0iYmxhY2siLz4KPHBhdGggZD0iTTE2LjIyOCAyLjYyODE5QzE1LjM0NDcgNS4xNzk0IDE4LjE0ODMgOC40NzQxOCAyMi41MDA5IDkuOTkzMzdDMjYuODUzNSAxMS41MTI2IDMxLjA5NzMgMTAuNjcyOCAzMS45ODA2IDguMTIxNjNDMzIuODYzOSA1LjU3MDQyIDMwLjA2MDMgMi4yNzU2NCAyNS43MDc3IDAuNzU2NDUyQzI0LjI0MTkgMC4yNDM2NDYgMjIuNzgyNSA2LjIyMDk2ZS0wNSAyMS40NjQgNi4xOTc5MWUtMDVDMTguODcxNiA2LjE1MjU4ZS0wNSAxNi44MTA1IDAuOTM1OTMzIDE2LjIyOCAyLjYyODE5WiIgZmlsbD0iYmxhY2siLz4KPHBhdGggZD0iTTM1Ljc5NiA3Ljc2OTc5QzM0LjUzNTEgOC4yNzYxOCAzNC44MzU5IDExLjk2MiAzNi40NjE3IDE1Ljk4NzVDMzguMDg3NSAyMC4wMTk0IDQwLjQyMzkgMjIuODcxOSA0MS42ODQ4IDIyLjM2NTVDNDIuOTM5NCAyMS44NTkxIDQyLjY0NSAxOC4xNzk4IDQxLjAxOTEgMTQuMTQ3OEMzOS41MjEzIDEwLjQzIDM3LjQxNTQgNy43MTIxIDM2LjEwOTcgNy43MTIxQzM2LjAwMDkgNy43MTIxIDM1Ljg5ODQgNy43MzEzMyAzNS43OTYgNy43Njk3OVoiIGZpbGw9ImJsYWNrIi8+CjxwYXRoIGQ9Ik0zNi43NjE5IDMyLjI2MjZDMzQuOTY5NyAzNi4xNTM1IDM0LjM0ODggMzkuNjk4MyAzNS4zNzkzIDQwLjE3MjZDMzYuNDA5OSA0MC42NDcgMzguNzAxNCAzNy44Nzc4IDQwLjQ5MzYgMzMuOTg2OUM0Mi4yOTIzIDMwLjA5NiA0Mi45MDY4IDI2LjU1MTIgNDEuODgyNiAyNi4wNzY5QzQxLjgwNTggMjYuMDM4NCA0MS43MjI2IDI2LjAyNTYgNDEuNjI2NiAyNi4wMjU2QzQwLjUwNjQgMjYuMDI1NiAzOC40MTk4IDI4LjY2NjUgMzYuNzYxOSAzMi4yNjI2WiIgZmlsbD0iYmxhY2siLz4KPC9zdmc+Cg==';

const IMAGE_DARK =
  'PHN2ZyB3aWR0aD0iNTgiIGhlaWdodD0iNjUiIHZpZXdCb3g9IjAgMCA1OCA2NSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMy4yNjM5NyAxMy43MjY1Qy0wLjk4OTc3MiAxOC42ODE3IC0xLjEwMTk0IDI1LjU3OTIgMy4wMjIzNyAyOS4xMTg3QzcuMTQ2NjkgMzIuNjY2NyAxMy45MzcxIDMxLjUxODYgMTguMTk5NSAyNi41NTQ3QzIyLjQ1MzIgMjEuNTk5NSAyMi41NjU0IDE0LjcwMiAxOC40NDExIDExLjE2MjZDMTYuODI3NiA5Ljc3MjcxIDE0Ljc5MTMgOS4xMDc5OSAxMi42Njg4IDkuMTA3OTlDOS4zNzI3NyA5LjEwNzk5IDUuODUyNDUgMTAuNzEzNyAzLjI2Mzk3IDEzLjcyNjVaIiBmaWxsPSJ3aGl0ZSIvPjxwYXRoIGQ9Ik0yLjAzMDAxIDM5LjM2NTdDLTEuMTcxMDggNDMuMTY0MSAwLjIxODA2NiA0OS42MTI4IDUuMTM2MTggNTMuNzY1MUMxMC4wNTQzIDU3LjkxNzQgMTYuNjQ2MyA1OC4yMTEgMTkuODQ3NCA1NC40MTI2QzIzLjA0ODUgNTAuNjE0MiAyMS42NTkzIDQ0LjE2NTUgMTYuNzQxMiA0MC4wMTMyQzE0LjEzNTUgMzcuODExOCAxMS4wNjM4IDM2LjY5ODIgOC4yNzY4NyAzNi42OTgyQzUuODAwNTUgMzYuNjk4MiAzLjUzOTk2IDM3LjU3ODcgMi4wMzg2NCAzOS4zNjU3IiBmaWxsPSJ3aGl0ZSIvPjxwYXRoIGQ9Ik0zMC45MDg3IDUzLjI2NDNDMjUuMTM2NCA1NS4wODU5IDIxLjE1ODggNTguNzk3OSAyMi4wMjE2IDYxLjU1MThDMjIuODkzMSA2NC4zMDU2IDI4LjI3NzEgNjUuMDY1MyAzNC4wNDk0IDYzLjIzNTFDMzkuODIxNyA2MS40MTM2IDQzLjc5OTQgNTcuNzAxNiA0Mi45MzY2IDU0Ljk0NzdDNDIuMzg0MyA1My4yMTI2IDQwLjAzNzUgNTIuMjYzIDM2LjkzMTMgNTIuMjYzQzM1LjExMDcgNTIuMjYzIDMzLjAzOTkgNTIuNTgyNCAzMC45MDg3IDUzLjI1NTciIGZpbGw9IndoaXRlIi8+PHBhdGggZD0iTTIxLjg3NDkgMy41Mzk0MkMyMC42ODQyIDYuOTc1MjQgMjQuNDYzNCAxMS40MTI1IDMwLjMzMDYgMTMuNDU4NEMzNi4xOTc5IDE1LjUwNDQgNDEuOTE4NCAxNC4zNzM1IDQzLjEwOTEgMTAuOTM3N0M0NC4yOTk4IDcuNTAxODQgNDAuNTIwNiAzLjA2NDYyIDM0LjY1MzQgMS4wMTg2NkMzMi42Nzc1IDAuMzI4MDQ0IDMwLjcxMDMgMCAyOC45MzI5IDBDMjUuNDM4NCAwIDIyLjY2MDEgMS4yNjAzOCAyMS44NzQ5IDMuNTM5NDJaIiBmaWxsPSJ3aGl0ZSIvPjxwYXRoIGQ9Ik00OC4yNTE2IDEwLjQ2MzhDNDYuNTUxOSAxMS4xNDU4IDQ2Ljk1NzQgMTYuMTA5NiA0OS4xNDkgMjEuNTMwOUM1MS4zNDA2IDI2Ljk2MDkgNTQuNDg5OSAzMC44MDI1IDU2LjE4OTcgMzAuMTIwNUM1Ny44ODA4IDI5LjQzODUgNTcuNDgzOSAyNC40ODMzIDU1LjI5MjMgMTkuMDUzNEM1My4yNzMzIDE0LjA0NjQgNTAuNDM0NiAxMC4zODYxIDQ4LjY3NDQgMTAuMzg2MUM0OC41Mjc3IDEwLjM4NjEgNDguMzg5NyAxMC40MTIgNDguMjUxNiAxMC40NjM4WiIgZmlsbD0id2hpdGUiLz48cGF0aCBkPSJNNDkuNTU0NCA0My40NDkxQzQ3LjEzODUgNDguNjg5MiA0Ni4zMDE1IDUzLjQ2MzEgNDcuNjkwNyA1NC4xMDE5QzQ5LjA3OTggNTQuNzQwNyA1Mi4xNjg4IDUxLjAxMTQgNTQuNTg0NyA0NS43NzEzQzU3LjAwOTIgNDAuNTMxMyA1Ny44Mzc2IDM1Ljc1NzQgNTYuNDU3IDM1LjExODVDNTYuMzUzNSAzNS4wNjY3IDU2LjI0MTMgMzUuMDQ5NSA1Ni4xMTE5IDM1LjA0OTVDNTQuNjAyIDM1LjA0OTUgNTEuNzg5MSAzOC42MDYyIDQ5LjU1NDQgNDMuNDQ5MVoiIGZpbGw9IndoaXRlIi8+PC9zdmc+';

export const QrCode = memo(({ value, size, theme = 'light' }: Props) => {
  const [ref, setRef] = useState<HTMLDivElement | null>(null);
  const isDark = theme === 'dark';
  const color = isDark ? COLOR_DARK : COLOR_LIGHT;
  const imageBase64 = isDark ? IMAGE_DARK : IMAGE_LIGHT;

  const qrCode = useMemo(() => {
    return new QRCodeStyling({
      data: value,
      type: 'svg',
      shape: 'square',
      width: size,
      height: size,
      margin: 0,
      image: imageBase64 ? `data:image/svg+xml;base64,${imageBase64}` : undefined,
      imageOptions: {
        hideBackgroundDots: true,
        imageSize: 0.3,
        margin: 10,
      },
      dotsOptions: {
        type: 'rounded',
        color,
      },
      backgroundOptions: {
        color: 'transparent',
      },
      cornersSquareOptions: {
        type: 'dot',
        color,
      },
      cornersDotOptions: {
        type: 'dot',
        color,
      },
      qrOptions: {
        errorCorrectionLevel: 'M',
      },
    });
  }, [size, theme, color, imageBase64]);

  useEffect(() => {
    if (ref) {
      qrCode.append(ref);
    }

    return () => {
      if (ref) {
        QRCodeStyling._clearContainer(ref);
      }
    };
  }, [qrCode, ref]);

  useEffect(() => {
    qrCode?.update({ data: value });
  }, [value, qrCode]);

  return <div className={styles.container} style={{ height: size, width: size }} ref={setRef} />;
});
